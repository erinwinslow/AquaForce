---
title: "Exploring the data"
date: "Last updated on `r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)
```

```{r}
suppressPackageStartupMessages({
  library(countrycode)
  library(seaaroundus)
  library(tidyverse)
  library(magrittr)
})
```

```{r}
load("Data/FAO_data.rds")
load("Data/sau_data.rds")
```

# Put data together

We are using FAO's data for [aquaculture production](http://www.fao.org/fishery/statistics/global-aquaculture-production/en) and [wild fisheries](http://www.fao.org/fishery/statistics/global-capture-production/en).

```{r}
FAO_sp_groups <- read.csv(file = "Data/FAO_spp_groups.csv", stringsAsFactors = FALSE) %>% 
  janitor::clean_names() %>% 
  select(species = x3alpha_code, family = family_group, order = order_group) %>% 
  mutate(family = taxize::taxize_capwords(family, onlyfirst = T),
         order = taxize::taxize_capwords(order, onlyfirst = T))

# Load FAO species codes lookup table
FAO_sp_codes <- read.csv(file = "Data/FAO_sp_codes.csv", stringsAsFactors = FALSE) %>% 
  janitor::clean_names() %>% 
  select(species = x3alpha_code, common_name = name_en, sci_name = scientific_name) %>% 
  left_join(FAO_sp_groups) %>% 
  select(order, family, sci_name, common_name, species, family, order)

# Load FAO country codes lookup table
FAO_cty_codes <- read.csv(file = "Data/FAO_cty_codes.csv", stringsAsFactors = F) %>% 
  select(country = UN_CODE, iso = Name_en)

# Load FAO aquaculture timeseries
FAO_ac_ts <- read.csv(file = "Data/FAO_ac_ts.csv", stringsAsFactors = F) %>%
  janitor::clean_names() %>% 
  filter(quantity > 0) %>% 
  left_join(FAO_sp_codes, by = "species") %>% 
  left_join(FAO_cty_codes, by = "country") %>% 
  janitor::clean_names() %>% 
  mutate(country = countrycode::countrycode(sourcevar = iso,
                                            origin = "iso3c",
                                            destination = "country.name",
                                            warn = F),
         source = "Aquaculture") %>% 
  group_by(year, production_area, country, iso, source, species, common_name, sci_name, family, order) %>% 
  summarize(quantity = sum(quantity, na.rm = T), value = sum(value, na.rm = T)) %>% 
  ungroup()

# Load FAO fisheries production timeseries
FAO_fi_ts <- read.csv(file = "Data/FAO_fi_ts.csv", stringsAsFactors = F) %>% 
  janitor::clean_names() %>% 
  filter(!unit == "no", quantity > 0) %>% 
  left_join(FAO_sp_codes, by = "species") %>% 
  left_join(FAO_cty_codes, by = "country") %>% 
  mutate(country = countrycode::countrycode(sourcevar = iso,
                                            origin = "iso3c",
                                            destination = "country.name",
                                            warn = F),
         source = "Catches",
         value = NA) %>% 
  select(year, production_area = fishing_area, country, iso, source, species, common_name, sci_name, family, order, quantity, value)

# Join them together
FAO_ts <- rbind(FAO_ac_ts, FAO_fi_ts) %>% 
  arrange(year, country, source, species, common_name, sci_name, family, order, quantity, value)
```

# Some data diagnostics

## Structure of the data

This listviewer widget lets us look at the "unique" values per column (each column in our dataset is a variable). For example, clicking on year will show all the years for which we have data. Note that this does not imply we have data for all countries on every year, but that there is at least one observation for any given year. The same is true for other variables.

```{r}
lapply(FAO_ts, FUN = function(x){sort(unique(x))}) %>% 
  listviewer::jsonedit()
```

## Total seafood production in the world

```{r}
FAO_ts %>% 
  group_by(source, year) %>% 
  summarize(Quantity = sum(quantity, na.rm = T) / 1000000) %>% 
  ggplot(aes(x = year, y = Quantity, fill = source)) +
  geom_area(color = "black", size = 0.5) +
  cowplot::theme_cowplot() +
  theme(legend.position = c(0.1,0.7)) +
  scale_fill_brewer(palette = "green3") +
  labs(x = "Year", y = "Million tones", caption = "(Data from FAO: www.fao.org/fishery/statistics/)") +
  scale_x_continuous(labels = seq(1955, 2015, by = 10), breaks = seq(1955, 2015, by = 10))
```

## Aquaculture and wildcaught fisheries by country

You can explore landings and aquaculture production by country by playing with this widget. Click on the expand button in the bottom-left corner to view it in full.

```{r, eval = F}
FAO_ts %>% 
  group_by(source, country, year) %>% 
  summarize(Quantity = sum(quantity, na.rm = T) / 1000000) %>% 
  ggplot(aes(x = year, y = Quantity, fill = source, group = source)) +
  geom_area(color = "black", size = 0.5) +
  cowplot::theme_cowplot() +
  theme(legend.position = c(0.1,0.7)) +
  scale_fill_brewer(palette = "green3") +
  labs(x = "Year", y = "Million tones") +
  trelliscopejs::facet_trelliscope(~country, nrow = 3, ncol = 3, width = 1000, height = 500, scales = "free", self_contained = T)
```

##  Write FAO data

Looks good, export the data

```{r, eval = F}
write.csv(FAO_ts, "./Data/FAO_data.csv", row.names = F)
save(FAO_ts, file = "./Data/FAO_data.rds")
```

# SAU data

## Get catch data from SeaAroundUs

```{r, eval = F}
catch_country <- function(id){
  seaaroundus::catchdata(region = "eez",
                         id = id,
                         dimension = "taxon",
                         limit = 1000) %>% 
    janitor::clean_names() %>% 
    gather(species, Landings, -years)
}

sau_catches <- seaaroundus::listregions("eez") %>% 
  arrange(id) %>% 
  mutate(catches = map(id, ~catch_country(.))) %>% 
  unnest() %>% 
  select(-id)
```

## Get value data from SeaAroundUs

```{r, eval = F}
value_country <- function(id){
  seaaroundus::catchdata(region = "eez",
                         id = id,
                         dimension = "taxon",
                         limit = 1000,
                         measure = "value") %>% 
    janitor::clean_names() %>% 
    gather(species, Value, -years)
}

sau_landings <- seaaroundus::listregions("eez") %>% 
  arrange(id) %>% 
  mutate(catches = map(id, ~value_country(.))) %>% 
  unnest() %>% 
  select(-id)
```

## Join catches and values

```{r, eval = F}
sau_data <- left_join(sau_catches, sau_landings, by = c("title", "years", "species")) %>% 
  janitor::clean_names() %>% 
  filter(landings > 0) %>% 
  mutate(ppt = value / landings)
```

## Plot SAU vs FAO

```{r}
aggregate_sau <- sau_data %>% 
  rename(year = years) %>% 
  group_by(year) %>% 
  summarize(quantity = sum(landings)) %>% 
  mutate(source = "SAU")

FAO_ts %>% 
  filter(source == "Catches") %>% 
  group_by(year) %>% 
  summarize(quantity = sum(quantity)) %>% 
  mutate(source = "FAO") %>% 
  rbind(aggregate_sau) %>% 
  ggplot(aes(x = year, y = quantity/1e6, color = source)) + 
  geom_line(size = 1) +
  scale_color_brewer(palette = "Set1") +
  labs(x = "Year", y = "Quantities (million MT)") +
  theme_minimal() +
  scale_x_continuous(limits = c(1950, 2020))
```

```{r}
FAO_ts %>% 
  filter(source == "Catches") %>% 
  group_by(year) %>% 
  summarize(quantity = sum(quantity)) %>% 
  mutate(source = "FAO") %>% 
  rbind(aggregate_sau) %>% 
  select(year, source, quantity) %>% 
  spread(source, quantity) %>% 
  mutate(difference = SAU - FAO) %>% 
  na.omit() %>% 
  ggplot(aes(x = year, y = difference/1e6, color = "1")) + 
  geom_line(size = 1) +
  scale_color_brewer(palette = "Set1") +
  labs(x = "Year", y = "Quantities (million MT)") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_x_continuous(limits = c(1950, 2020)) +
  scale_y_continuous(limits = c(0, 30))

```

## Export SAU

```{r, eval = F}
write.csv(sau_data, "./Data/SAU_data.csv", row.names = F)
save(sau_data, file = "./Data/sau_data.rds")
```


# Looking into Salmon

## Plotting by salmon species

```{r}
FAO_ts %>% 
  filter(species %in% c("PIN", "CHI", "SOC", "COH", "SAL")) %>% 
  group_by(source, year, sci_name) %>% 
  summarize(Quantity = sum(quantity, na.rm = T) / 1000000) %>% 
  mutate(Unit = paste(source, sci_name)) %>% 
  ggplot(aes(x = year, y = Quantity, fill = Unit, group = Unit)) +
  geom_area(color = "black", size = 0.5) +
  cowplot::theme_cowplot() +
  theme(legend.position = c(0.1,0.7)) +
  scale_fill_brewer(palette = "green3") +
  labs(x = "Year", y = "Million tones", caption = "(Data from FAO: www.fao.org/fishery/statistics/)") +
  scale_x_continuous(labels = seq(1955, 2015, by = 10), breaks = seq(1955, 2015, by = 10))
```

## Plotting all salmon species

```{r}
FAO_ts %>% 
  filter(species %in% c("PIN", "CHI", "SOC", "COH", "SAL")) %>% 
  group_by(source, year) %>% 
  summarize(Quantity = sum(quantity, na.rm = T) / 1000000) %>% 
  ggplot(aes(x = year, y = Quantity, fill = source)) +
  geom_area(color = "black", size = 0.5) +
  cowplot::theme_cowplot() +
  theme(legend.position = c(0.1,0.7)) +
  scale_fill_brewer(palette = "green3") +
  labs(x = "Year", y = "Million tones", caption = "(Data from FAO: www.fao.org/fishery/statistics/)") +
  scale_x_continuous(labels = seq(1955, 2015, by = 10), breaks = seq(1955, 2015, by = 10))
```

# Get salmon and lobster data

```{r}
## from FAO
fao_salmon_lobster <- FAO_ts %>% 
  mutate(lobster = grepl(pattern = "lobster", x = common_name),
         salmon = grepl(pattern = "salmon", x = common_name),
         general_name = case_when(lobster ~ "Lobster",
                                  TRUE ~ "Salmon")) %>% 
  filter(lobster | salmon) %>% 
  mutate(common_name = tolower(gsub(pattern = " nei", replacement = "", x = common_name)),
          common_name = gsub("\\s*\\([^\\)]+\\)", "", common_name))
```

```{r}
fao_salmon_lobster  %>%
  group_by(year, source, general_name) %>% 
  summarize(quantity = sum(quantity)) %>% 
  filter(!(general_name == "Lobster" & source == "Aquaculture")) %>% 
  rename(Species = general_name) %>% 
  ggplot(aes(x = year, y = quantity/1000000, color = source, linetype = Species, group = paste(source, Species))) +
  geom_line(size = 1) +
  scale_color_brewer(palette = "Set1") +
  geom_vline(xintercept = 1962, linetype = "dashed") +
  geom_text(aes(x = 1975, y = 2.5, label = "Salmon aquaculture begins"), color = "black", size = 4) +
  labs(x = "Year", y = "Quantities (million MT)", caption = "(Data from FAO: www.fao.org/fishery/statistics/)") +
  theme_minimal()
```

```{r, eval = F}
write.csv(fao_salmon_lobster, file = "./Data/fao_salmon_lobster.csv", row.names = F)
```

Model 1:

$$
log(Q_{t,s}) = \alpha + \beta_1log(A_{t, s}) +\epsilon_{t,s}
$$
Model 2:

$$
log(Q_{t,s}) = \alpha + \beta_1log(A_{t, s}) + \sum_{t = 1}^T\gamma_tYear_t +\epsilon_{t,s}
$$

Model 3:

$$
log(Q_{t,s}) = \alpha + \beta_1log(A_{t, s}) + \sum_{t = 1}^T\gamma_tYear_t \sum_{s = 1}^S{\sigma_sSpp_s} +\epsilon_{t,s}
$$

Model 4:

$$
log(Q_{t,s,c}) = \alpha + \beta_1log(A_{t, s}) + \sum_{t = 1}^T\gamma_tYear_t \sum_{s = 1}^S{\sigma_sSpp_s} + \sum_{c = 1}^C \Omega_cCountry +\epsilon_{t,s,c}
$$

Model 5:

$$
log(Q_{t,s,c,p}) = \alpha + \beta_1log(A_{t, s}) + \sum_{t = 1}^T\gamma_tYear_t \sum_{s = 1}^S{\sigma_sSpp_s} + \sum_{c = 1}^C \Omega_cCountry + \sum_{p = 1}^P Prod_p +\epsilon_{t,s,c}
$$

```{r}

fao_salmon_lobster_aqua <- filter(fao_salmon_lobster, source == "Aquaculture") %>% 
  group_by(year, species, common_name, sci_name) %>% 
  summarize(aquaculture = sum(quantity, na.rm = T))

fao_salmon_lobster_model <- filter(fao_salmon_lobster, source == "Catches") %>% 
  select(year, production_area,
         country,
         iso,
         general_name,
         species,
         common_name,
         sci_name,
         quantity) %>% 
  left_join(fao_salmon_lobster_aqua, by = c("year", "sci_name", "species", "common_name")) %>% 
  mutate(log10_aqua = ifelse(is.na(log10(aquaculture)), 0, log10(aquaculture)),
         post = ifelse(log10_aqua > 0, 1, 0),
         post = ifelse(year > 1962 & general_name == "Lobster", 1, post)) %>% 
  replace_na(list(aquaculture = 0))

model1 <- lm(log10(quantity) ~ log10_aqua, fao_salmon_lobster_model)

model2 <- lm(log10(quantity) ~ factor(year) + log10_aqua, fao_salmon_lobster_model)

model3 <- lm(log10(quantity) ~ factor(year) + log10_aqua + species, fao_salmon_lobster_model)

model4 <- lm(log10(quantity) ~ factor(year) + log10_aqua + species + iso, fao_salmon_lobster_model)

model5 <- lm(log10(quantity) ~ factor(year) + log10_aqua + species + iso + production_area, fao_salmon_lobster_model)

model6 <- lm(log10(quantity) ~ post*general_name, data = fao_salmon_lobster_model)

```

```{r, results = "asis"}
stargazer::stargazer(model1, model2, model3, model4, model5, model6,
                     single.row = T,
                     type = "html",
                     intercept.bottom = F, omit = c("year", "iso", "species"))
```

# Load RAM Legacy database

```{r}
ram <- read.csv("Data/RAM.csv", stringsAsFactors = F) %>% 
  janitor::clean_names()
```

```{r}
lobster_salmon_ram <- ram %>% 
  mutate(lobster = grepl(pattern = "lobster", x = stocklong),
         salmon = grepl(pattern = "salmon", x = stocklong),
         general_name = case_when(lobster ~ "Lobster",
                                  TRUE ~ "Salmon")) %>% 
  filter(lobster | salmon,
         tsid == "BdivBmsytouse-dimensionless")
```

```{r}
lobster_salmon_ram %>% 
  group_by(tsyear, general_name) %>% 
  summarize(tsvalue = median(tsvalue, na.rm = T)) %>% 
  ggplot(aes(x = tsyear, y = tsvalue, color = general_name, group = general_name)) +
  geom_line(size = 1) +
  theme_bw()
```

# Get the list of species ranked highest

```{r}

FAO_fi_ts <- FAO_ts %>% 
  filter(source == "Catches")

FAO_ac_ts <- FAO_ts %>% 
  filter(!source == "Catches")

cut <- 0.85

## Wildcaught fisheries, top 95th percentile, quantities
f95q <- FAO_fi_ts %>% 
   filter(year == 2014,
          !common_name %in% c("Marine fishes nei", "Freshwater fishes nei")) %>% 
   mutate(common_name = tolower(gsub(pattern = " nei", replacement = "", x = common_name)),
          common_name = gsub("\\s*\\([^\\)]+\\)", "", common_name)) %>% 
   group_by(common_name, sci_name) %>% 
   summarize(quantity = sum(quantity)) %>% 
   ungroup() %>% 
   filter(quantity >= quantile(quantity, cut)) %>% 
   arrange(desc(quantity)) %>% 
   mutate(rank_fq = row_number(desc(quantity)))

## Wildcaught fisheries, top 95th percentile, values
f95v <- sau_data %>% 
   filter(years == 2014, !species == "others") %>% 
   mutate(species = gsub(pattern = "_", replacement = " ", x = species)) %>% 
   group_by(species) %>% 
   summarize(value = sum(value)) %>% 
   ungroup() %>% 
   filter(value >= quantile(value, cut)) %>% 
   arrange(desc(value)) %>% 
   mutate(rank_fv = row_number(desc(value)))

## Aquaculture, top 95th percentile, quantities
a95q <- FAO_ac_ts %>% 
   filter(year == 2014,
          !common_name %in% c("Marine fishes nei", "Freshwater fishes nei")) %>% 
   mutate(common_name = tolower(gsub(pattern = " nei", replacement = "", x = common_name)),
          common_name = gsub("\\s*\\([^\\)]+\\)", "", common_name)) %>% 
   group_by(common_name, sci_name) %>% 
   summarize(quantity = sum(quantity)) %>%
   ungroup() %>% 
   filter(quantity >= quantile(quantity, cut)) %>% 
   arrange(desc(quantity)) %>% 
   mutate(rank_aq = row_number(desc(quantity)))

## Aquaculture, top 95th percentile, values
a95v <- FAO_ac_ts %>% 
   filter(year == 2014,
          !common_name %in% c("Marine fishes nei", "Freshwater fishes nei")) %>% 
   mutate(common_name = tolower(gsub(pattern = " nei", replacement = "", x = common_name)),
          common_name = gsub("\\s*\\([^\\)]+\\)", "", common_name)) %>% 
   group_by(common_name, sci_name) %>% 
   summarize(value = sum(value)) %>% 
   ungroup() %>% 
   filter(value >= quantile(value, cut)) %>% 
   arrange(desc(value)) %>% 
   mutate(rank_av = row_number(desc(value)))
```



## Joining them all

### Key

I had to cut them at 80th percentila to actually get some data on both groups

- fq = fisheries quantities
- fv = fisheries value
- aq = aquaculture quantities
- av = aquaculture value
- Discard means that there is only aquaculture for them, but no fisheries (at least not in relevant quantities with this cuttof at 0.8)

```{r}
full_join(f95q, f95v, by = c("common_name" = "species")) %>% 
  select(-c(quantity, value)) %>% 
  full_join(a95q, by = c("common_name", "sci_name")) %>% 
  full_join(a95v,  by = c("common_name", "sci_name")) %>% 
  select(-c(quantity, value)) %>% 
  replace_na(replace = list(rank_fq = 0, rank_fv = 0, rank_aq = 0, rank_av = 0)) %>% 
  mutate(fish = ifelse(rank_fq + rank_fv > 0, 1, 0),
         aqua = ifelse(rank_aq + rank_av > 0, 1, 0),
         group = case_when(aqua + fish == 2 ~ "Treatment",
                           aqua + fish == 1 & aqua == 1 ~ "Discard",
                           aqua + fish == 1 & fish == 1 ~ "Control")) %>% 
  select(-c(fish, aqua)) %>% 
  select(group, everything()) %>% 
  DT::datatable(options = list(pageLength = 50))
```

## New take at treated vs control

```{r}
A <- FAO_ts %>%
  filter(source == "Aquaculture") %>%
  group_by(source, family) %>%
  tally() %$%
  family

Fi <- FAO_ts %>%
  filter(!source == "Aquaculture") %>%
  group_by(source, family) %>%
  tally() %$%
  family

treated <- intersect(A, Fi)
control <- Fi[!Fi %in% intersect(A, Fi)]

cut <- 0.90

select_treated <- filter(FAO_ts, family %in% treated) %>%
  filter(!family == "") %>% 
  group_by(family) %>%
  summarize(total = sum(quantity, na.rm = T)) %>%
  arrange(desc(total)) %>% 
  filter(total >= quantile(total, cut)) %>% 
  mutate(group = "treated") %>% 
   mutate(rank = row_number(desc(total)))

select_control <- filter(FAO_ts, family %in% control) %>%
  filter(!family == "") %>% 
  group_by(family) %>%
  summarize(total = sum(quantity, na.rm = T)) %>%
  arrange(desc(total)) %>% 
  filter(total >= quantile(total, cut)) %>% 
  mutate(group = "control") %>% 
   mutate(rank = row_number(desc(total)))


# number of species in control families

FAO_sp_codes %>%
  filter(family %in% select_control$family) %>%
  group_by(family, species) %>%
  tally() %>%
  select(-n) %>%
  group_by(family) %>%
  tally() %$%
  sum(n)

# number of species in treated families

FAO_sp_codes %>%
  filter(family %in% select_treated$family) %>%
  group_by(family, species) %>%
  tally() %>%
  select(-n) %>%
  group_by(family) %>%
  tally() %$%
  sum(n)

# Historical production
h_prod <- FAO_ts %>% 
  filter(family %in% select_treated$family,
         !source == "Aquaculture",
         !sci_name %in% c("Salmo trutta", "Salmo spp", "Oncorhynchus mykiss")) %>%
  group_by(family) %>% 
  summarize(quantity_5p = mean(quantity)*0.1)

FAO_ts %>%
  filter(family %in% select_treated$family,
         source == "Aquaculture",
         !sci_name %in% c("Salmo trutta", "Salmo spp", "Oncorhynchus mykiss")) %>%
  group_by(family, year) %>% 
  summarize(quantity = sum(quantity)) %>% 
  ungroup() %>% 
  left_join(h_prod, by = "family") %>% 
  mutate(post = ifelse(quantity <= quantity_5p, 0, 1)) %>% 
  filter(post > 0) %>% 
  group_by(family) %>% 
  summarize(year_start = min(year)) %>% 
  arrange(year_start) %>% 
  filter(year_start > 1955) -> aq_treated_families

```


year, country, family, species quantity, aquaculture, post, group

```{r}
control_group <- FAO_ts %>% 
  filter(family %in% select_control$family,
         !family == "Engraulidae") %>%
  group_by(year, iso, family, species, sci_name) %>% 
  summarize(quantity = sum(quantity)) %>% 
  ungroup() %>% 
  mutate(group = 0,
         year_start = 1989,
         post = ifelse(year <= year_start, 0, 1),
         aquaculture = 0) %>% 
  select(year, country = iso, family, species, sci_name, quantity, aquaculture, post, group, year_start)
```


```{r}
treatment_group_ac <- FAO_ts %>% 
  filter(family %in% aq_treated_families$family,
         source == "Aquaculture",
         !sci_name %in% c("Salmo trutta", "Salmo spp", "Oncorhynchus mykiss")) %>% 
  group_by(year, family) %>% 
  summarize(aquaculture = sum(quantity)) %>% 
  ungroup()

treatment_group <- FAO_ts %>% 
  filter(family %in% aq_treated_families$family,
         source == "Aquaculture",
         !sci_name %in% c("Salmo trutta", "Salmo spp", "Oncorhynchus mykiss")) %>%
  group_by(year, iso, family, species, sci_name) %>% 
  summarize(quantity = sum(quantity)) %>% 
  ungroup() %>% 
  left_join(aq_treated_families, by = "family") %>% 
  mutate(group = 1,
         post = ifelse(year <= year_start, 0, 1)) %>% 
  left_join(treatment_group_ac, by = c("year", "family")) %>% 
  select(year, country = iso, family, species, sci_name, quantity, aquaculture, post, group, year_start)
```


```{r}
data_for_model <- rbind(control_group, treatment_group) %>% 
  filter(!country == "")
```


The diff-in-diff model you presented in class looked something like:

$$y_{it} = \beta_1 * Salmon_i * Post_t + \beta_2*Salmon_i + \beta_3*Post_t + e_{it}$$

where Salmon_i is a dummy equal to one if i refers to a salmon and Post_t is a dummy equal to one if t is after the introduction of salmon aquaculture. This estimator basically fits a constant effect for all post aquaculture years.

$$ln(quantity_{it}) = \beta_1 G_i\times Post_t + \beta_2G_i + \beta_3Post_t + \sum_{f = 1}^{30}\gamma_fF_f + ln(aquacultur+1) + \sum_{t = 1}^T\Omega_tt+ \epsilon_{it}$$

```{r}
make_robust <- function(model){
  model %>% 
    lmtest::coeftest(sandwich::vcovHC(., type = "HC2"), cluster = "family") %>% 
    broom::tidy() -> new_test
  
  robust_se <- new_test$std.error
  names(robust_se) <- new_test$term
  
  return(robust_se)
}
```


```{r}
lm(log(quantity) ~ group*post + as.factor(year) + family + log(aquaculture + 1) -1, data_for_model) %>% 
  stargazer::stargazer(se = list(make_robust(.)), t.auto = T, p.auto = T, single.row = T, omit = c("family", "year"), out = "table.html")
```



As an alternative, you can do what's called an "event study" plot where you now have:  

$$y_{it} = \sum_{\frac{-12<s<30}{s \neq 0}} \beta_s * Salmon_i * event_s + \beta_2*Salmon_i + \beta_3*Post_t + e_{it}$$

$$ln(Q) = \sum_{\frac{-12<s<30}{s \neq 0}} \beta_s G_i\times event_s + \beta_2G_i + \beta_3Post_t + \sum_{f = 1}^{30}\gamma_fF_f + ln(aquacultur+1) + \sum_{t = 1}^T\Omega_tt+ \epsilon_{it}$$

where now $event_s$ are dummies that equal one for each year before and after the introduction of aquaculture. The year of the introduction will be the omitted variable. You effective estimate a time varying effect before and after aquaculture's introduction. The idea here is to allow the data to tell you what that response is over time. The coefficients prior to the treatment will serve as tests for differential pre-trends between lobster and salmon prior to the salmon aquaculture introduction. I want you guys to plot the $\beta_s$ coefficients and its associated standard errors. 

```{r}

T0 <- tibble(term = "group:T0", estimate = 0, std.error = 0, statistic = 0, p.value = NA, year = 0)

data_for_model %>% 
  mutate(year = year - year_start,
         Tm12 = (year == -12)*1,
         Tm11 = (year == -12)*1,
         Tm10 = (year == -10)*1,
         Tm9 = (year == -9)*1,
         Tm8 = (year == -8)*1,
         Tm7 = (year == -7)*1,
         Tm6 = (year == -6)*1,
         Tm5 = (year == -5)*1,
         Tm4 = (year == -4)*1,
         Tm3 = (year == -3)*1,
         Tm2 = (year == -2)*1,
         Tm1 = (year == -1)*1,
         T0 = (year == 0)*1,
         T1 = (year == 1)*1,
         T2 = (year == 2)*1,
         T3 = (year == 3)*1,
         T4 = (year == 4)*1,
         T5 = (year == 5)*1,
         T6 = (year == 6)*1,
         T7 = (year == 7)*1,
         T8 = (year == 8)*1,
         T9 = (year == 9)*1,
         T10 = (year == 10)*1,
         T11 = (year == 11)*1,
         T12 = (year == 12)*1,
         T13 = (year == 13)*1,
         T14 = (year == 14)*1,
         T15 = (year == 15)*1,
         T16 = (year == 16)*1,
         T17 = (year == 17)*1,
         T18 = (year == 18)*1,
         T19 = (year == 19)*1,
         T20 = (year == 20)*1,
         T21 = (year == 21)*1,
         T22 = (year == 22)*1,
         T23 = (year == 23)*1,
         T24 = (year == 24)*1,
         T25 = (year == 25)*1,
         T26 = (year == 26)*1,
         T27 = (year == 27)*1,
         T28 = (year == 28)*1,
         T29 = (year == 29)*1,
         T30 = (year == 30)*1) %>% 
  filter(dplyr::between(year, -12, 30)) %>% 
  lm(formula = log(quantity) ~ group*(Tm12 + Tm11 + Tm10 + Tm9 + Tm8 + Tm7 + Tm6 + Tm5 + Tm4 + Tm3 + Tm2 + Tm1 +T1 + T2 + T3 + T4 + T5 + T6 + T7 + T8 + T9 + T10 + T11 + T12 + T13 + T14 + T15 + T16 + T17 + T18 + T10 + T20 + T21 + T22 + T24 + T25 + T26 +T27 + T28 + T29 + T30) + group +  post +log(aquaculture + 1) + family + as.factor(year) -1, data = .) %>%
  lmtest::coeftest(plm::vcovHC(., type = "HC2", cluster = "family")) %>% 
  broom::tidy() %>% 
  filter(grepl(pattern = "(group:T)", x = term)) %>%
  mutate(year = substring(term, 8,10),
         year = gsub(pattern = "m", replacement = "-", year),
         year = as.numeric(year)) %>% 
  rbind(T0) %>% 
  ggplot(aes(x = year, y = estimate)) +
  geom_ribbon(aes(ymin = estimate - std.error, ymax = estimate + std.error), fill = "gray", alpha = 0.5) +
  geom_line(color = "red", size = 1) +
  cowplot::theme_cowplot() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(x = "years since aquaculture", y = bquote(beta[s]))
```


```{r}
fao_salmon_lobster_model %>% 
  mutate(salmon = 1*(general_name == "Salmon"),
         year = year - 1964,
         Tm12 = (year == -12)*1,
         Tm11 = (year == -12)*1,
         Tm10 = (year == -10)*1,
         Tm9 = (year == -9)*1,
         Tm8 = (year == -8)*1,
         Tm7 = (year == -7)*1,
         Tm6 = (year == -6)*1,
         Tm5 = (year == -5)*1,
         Tm4 = (year == -4)*1,
         Tm3 = (year == -3)*1,
         Tm2 = (year == -2)*1,
         Tm1 = (year == -1)*1,
         T0 = (year == 0)*1,
         T1 = (year == 1)*1,
         T2 = (year == 2)*1,
         T3 = (year == 3)*1,
         T4 = (year == 4)*1,
         T5 = (year == 5)*1,
         T6 = (year == 6)*1,
         T7 = (year == 7)*1,
         T8 = (year == 8)*1,
         T9 = (year == 9)*1,
         T10 = (year == 10)*1,
         T11 = (year == 11)*1,
         T12 = (year == 12)*1,
         T13 = (year == 13)*1,
         T14 = (year == 14)*1,
         T15 = (year == 15)*1,
         T16 = (year == 16)*1,
         T17 = (year == 17)*1,
         T18 = (year == 18)*1,
         T19 = (year == 19)*1,
         T20 = (year == 20)*1,
         T21 = (year == 21)*1,
         T22 = (year == 22)*1,
         T23 = (year == 23)*1,
         T24 = (year == 24)*1,
         T25 = (year == 25)*1,
         T26 = (year == 26)*1,
         T27 = (year == 27)*1,
         T28 = (year == 28)*1,
         T29 = (year == 29)*1,
         T30 = (year == 30)*1) %>% 
  filter(dplyr::between(year, -12, 30)) %>% 
  lm(formula = log(quantity) ~ salmon*(Tm12 + Tm11 + Tm10 + Tm9 + Tm8 + Tm7 + Tm6 + Tm5 + Tm4 + Tm3 + Tm2 + Tm1 +T1 + T2 + T3 + T4 + T5 + T6 + T7 + T8 + T9 + T10 + T11 + T12 + T13 + T14 + T15 + T16 + T17 + T18 + T10 + T20 + T21 + T22 + T24 + T25 + T26 +T27 + T28 + T29 + T30) + post +sci_name -1, data = .) %>%
  lmtest::coeftest(plm::vcovHC(., type = "HC2", cluster = "sci_name")) %>% 
  broom::tidy() %>% 
  filter(grepl(pattern = "(salmon:T)", x = term)) %>%
  mutate(year = substring(term, 9,10),
         year = gsub(pattern = "m", replacement = "-", year),
         year = as.numeric(year)) %>% 
  rbind(T0) %>% 
  ggplot(aes(x = year, y = estimate)) +
  geom_ribbon(aes(ymin = estimate - std.error, ymax = estimate + std.error), fill = "gray", alpha = 0.5) +
  geom_line(color = "red", size = 1) +
  cowplot::theme_cowplot() +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(x = "years since aquaculture", y = bquote(beta[s]))
```






