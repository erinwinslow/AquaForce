---
title: "Exploring the data"
date: "Last updated on `r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)
```

```{r}
suppressPackageStartupMessages({
  library(countrycode)
  library(seaaroundus)
  library(tidyverse)
})
```

```{r}
load("Data/FAO_data.rds")
load("Data/sau_data.rds")
```

# Put data together

We are using FAO's data for [aquaculture production](http://www.fao.org/fishery/statistics/global-aquaculture-production/en) and [wild fisheries](http://www.fao.org/fishery/statistics/global-capture-production/en).

```{r, eval = F}
FAO_sp_groups <- read.csv(file = "Data/FAO_spp_groups.csv", stringsAsFactors = F) %>% 
  janitor::clean_names() %>% 
  select(species = x3alpha_code, family = family_group, order = order_group) %>% 
  mutate(family = taxize::taxize_capwords(family, onlyfirst = T),
         order = taxize::taxize_capwords(order, onlyfirst = T))

# Load FAO species codes lookup table
FAO_sp_codes <- read.csv(file = "Data/FAO_sp_codes.csv", stringsAsFactors = F) %>% 
  janitor::clean_names() %>% 
  select(species = x3alpha_code, common_name = name_en, sci_name = scientific_name) %>% 
  left_join(FAO_sp_groups) %>% 
  select(order, family, sci_name, common_name, species)

# Load FAO country codes lookup table
FAO_cty_codes <- read.csv(file = "Data/FAO_cty_codes.csv", stringsAsFactors = F) %>% 
  select(country = UN_CODE, iso = Name_en)

# Load FAO aquaculture timeseries
FAO_ac_ts <- read.csv(file = "Data/FAO_ac_ts.csv", stringsAsFactors = F) %>%
  janitor::clean_names() %>% 
  filter(quantity > 0) %>% 
  left_join(FAO_sp_codes, by = "species") %>% 
  left_join(FAO_cty_codes, by = "country") %>% 
  janitor::clean_names() %>% 
  mutate(country = countrycode::countrycode(sourcevar = iso,
                                            origin = "iso3c",
                                            destination = "country.name",
                                            warn = F),
         source = "Aquaculture") %>% 
  group_by(year, production_area, country, iso, source, species, common_name, sci_name) %>% 
  summarize(quantity = sum(quantity, na.rm = T), value = sum(value, na.rm = T)) %>% 
  ungroup()

# Load FAO fisheries production timeseries
FAO_fi_ts <- read.csv(file = "Data/FAO_fi_ts.csv", stringsAsFactors = F) %>% 
  janitor::clean_names() %>% 
  filter(!unit == "no", quantity > 0) %>% 
  left_join(FAO_sp_codes, by = "species") %>% 
  left_join(FAO_cty_codes, by = "country") %>% 
  mutate(country = countrycode::countrycode(sourcevar = iso,
                                            origin = "iso3c",
                                            destination = "country.name",
                                            warn = F),
         source = "Catches",
         value = NA) %>% 
  select(year, production_area = fishing_area, country, iso, source, species, common_name, sci_name, quantity, value)

# Join them together
FAO_ts <- rbind(FAO_ac_ts, FAO_fi_ts) %>% 
  arrange(year, country, source, species, common_name, sci_name, quantity, value)
```

# Some data diagnostics

## Structure of the data

This listviewer widget lets us look at the "unique" values per column (each column in our dataset is a variable). For example, clicking on year will show all the years for which we have data. Note that this does not imply we have data for all countries on every year, but that there is at least one observation for any given year. The same is true for other variables.

```{r}
lapply(FAO_ts, FUN = function(x){sort(unique(x))}) %>% 
  listviewer::jsonedit()
```

## Total seafood production in the world

```{r}
FAO_ts %>% 
  group_by(source, year) %>% 
  summarize(Quantity = sum(quantity, na.rm = T) / 1000000) %>% 
  ggplot(aes(x = year, y = Quantity, fill = source)) +
  geom_area(color = "black", size = 0.5) +
  cowplot::theme_cowplot() +
  theme(legend.position = c(0.1,0.7)) +
  scale_fill_brewer(palette = "green3") +
  labs(x = "Year", y = "Million tones", caption = "(Data from FAO: www.fao.org/fishery/statistics/)") +
  scale_x_continuous(labels = seq(1955, 2015, by = 10), breaks = seq(1955, 2015, by = 10))
```

## Aquaculture and wildcaught fisheries by country

You can explore landings and aquaculture production by country by playing with this widget. Click on the expand button in the bottom-left corner to view it in full.

```{r, eval = F}
FAO_ts %>% 
  group_by(source, country, year) %>% 
  summarize(Quantity = sum(quantity, na.rm = T) / 1000000) %>% 
  ggplot(aes(x = year, y = Quantity, fill = source, group = source)) +
  geom_area(color = "black", size = 0.5) +
  cowplot::theme_cowplot() +
  theme(legend.position = c(0.1,0.7)) +
  scale_fill_brewer(palette = "green3") +
  labs(x = "Year", y = "Million tones") +
  trelliscopejs::facet_trelliscope(~country, nrow = 3, ncol = 3, width = 1000, height = 500, scales = "free", self_contained = T)
```

##  Write FAO data

Looks good, export the data

```{r, eval = F}
write.csv(FAO_ts, "./Data/FAO_data.csv", row.names = F)
save(FAO_ts, file = "./Data/FAO_data.rds")
```

# SAU data

## Get catch data from SeaAroundUs

```{r, eval = F}
catch_country <- function(id){
  seaaroundus::catchdata(region = "eez",
                         id = id,
                         dimension = "taxon",
                         limit = 1000) %>% 
    janitor::clean_names() %>% 
    gather(species, Landings, -years)
}

sau_catches <- seaaroundus::listregions("eez") %>% 
  arrange(id) %>% 
  mutate(catches = map(id, ~catch_country(.))) %>% 
  unnest() %>% 
  select(-id)
```

## Get value data from SeaAroundUs

```{r, eval = F}
value_country <- function(id){
  seaaroundus::catchdata(region = "eez",
                         id = id,
                         dimension = "taxon",
                         limit = 1000,
                         measure = "value") %>% 
    janitor::clean_names() %>% 
    gather(species, Value, -years)
}

sau_landings <- seaaroundus::listregions("eez") %>% 
  arrange(id) %>% 
  mutate(catches = map(id, ~value_country(.))) %>% 
  unnest() %>% 
  select(-id)
```

## Join catches and values

```{r, eval = F}
sau_data <- left_join(sau_catches, sau_landings, by = c("title", "years", "species")) %>% 
  janitor::clean_names() %>% 
  filter(landings > 0) %>% 
  mutate(ppt = value / landings)
```

## Plot SAU vs FAO

```{r}
aggregate_sau <- sau_data %>% 
  rename(year = years) %>% 
  group_by(year) %>% 
  summarize(quantity = sum(landings)) %>% 
  mutate(source = "SAU")

FAO_ts %>% 
  filter(source == "Catches") %>% 
  group_by(year) %>% 
  summarize(quantity = sum(quantity)) %>% 
  mutate(source = "FAO") %>% 
  rbind(aggregate_sau) %>% 
  ggplot(aes(x = year, y = quantity/1e6, color = source)) + 
  geom_line(size = 1) +
  scale_color_brewer(palette = "Set1") +
  labs(x = "Year", y = "Quantities (million MT)") +
  theme_minimal() +
  scale_x_continuous(limits = c(1950, 2020))
```

```{r}
FAO_ts %>% 
  filter(source == "Catches") %>% 
  group_by(year) %>% 
  summarize(quantity = sum(quantity)) %>% 
  mutate(source = "FAO") %>% 
  rbind(aggregate_sau) %>% 
  select(year, source, quantity) %>% 
  spread(source, quantity) %>% 
  mutate(difference = SAU - FAO) %>% 
  na.omit() %>% 
  ggplot(aes(x = year, y = difference/1e6, color = "1")) + 
  geom_line(size = 1) +
  scale_color_brewer(palette = "Set1") +
  labs(x = "Year", y = "Quantities (million MT)") +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_x_continuous(limits = c(1950, 2020)) +
  scale_y_continuous(limits = c(0, 30))

```

## Export SAU

```{r, eval = F}
write.csv(sau_data, "./Data/SAU_data.csv", row.names = F)
save(sau_data, file = "./Data/sau_data.rds")
```


# Looking into Salmon

## Plotting by salmon species

```{r}
FAO_ts %>% 
  filter(species %in% c("PIN", "CHI", "SOC", "COH", "SAL")) %>% 
  group_by(source, year, sci_name) %>% 
  summarize(Quantity = sum(quantity, na.rm = T) / 1000000) %>% 
  mutate(Unit = paste(source, sci_name)) %>% 
  ggplot(aes(x = year, y = Quantity, fill = Unit, group = Unit)) +
  geom_area(color = "black", size = 0.5) +
  cowplot::theme_cowplot() +
  theme(legend.position = c(0.1,0.7)) +
  scale_fill_brewer(palette = "green3") +
  labs(x = "Year", y = "Million tones", caption = "(Data from FAO: www.fao.org/fishery/statistics/)") +
  scale_x_continuous(labels = seq(1955, 2015, by = 10), breaks = seq(1955, 2015, by = 10))
```

## Plotting all salmon species

```{r}
FAO_ts %>% 
  filter(species %in% c("PIN", "CHI", "SOC", "COH", "SAL")) %>% 
  group_by(source, year) %>% 
  summarize(Quantity = sum(quantity, na.rm = T) / 1000000) %>% 
  ggplot(aes(x = year, y = Quantity, fill = source)) +
  geom_area(color = "black", size = 0.5) +
  cowplot::theme_cowplot() +
  theme(legend.position = c(0.1,0.7)) +
  scale_fill_brewer(palette = "green3") +
  labs(x = "Year", y = "Million tones", caption = "(Data from FAO: www.fao.org/fishery/statistics/)") +
  scale_x_continuous(labels = seq(1955, 2015, by = 10), breaks = seq(1955, 2015, by = 10))
```

# Get salmon and lobster data

```{r}
## from FAO
fao_salmon_lobster <- FAO_ts %>% 
  mutate(lobster = grepl(pattern = "lobster", x = common_name),
         salmon = grepl(pattern = "salmon", x = common_name),
         general_name = case_when(lobster ~ "Lobster",
                                  TRUE ~ "Salmon")) %>% 
  filter(lobster | salmon)
```

```{r}
fao_salmon_lobster  %>%
  group_by(year, source, general_name) %>% 
  summarize(quantity = sum(quantity)) %>% 
  filter(!(general_name == "Lobster" & source == "Aquaculture")) %>% 
  rename(Species = general_name) %>% 
  ggplot(aes(x = year, y = quantity/1000000, color = source, linetype = Species, group = paste(source, Species))) +
  geom_line(size = 1) +
  scale_color_brewer(palette = "Set1") +
  geom_vline(xintercept = 1962, linetype = "dashed") +
  geom_text(aes(x = 1975, y = 2.5, label = "Salmon aquaculture begins"), color = "black", size = 4) +
  labs(x = "Year", y = "Quantities (million MT)", caption = "(Data from FAO: www.fao.org/fishery/statistics/)") +
  theme_minimal()
```

```{r, eval = F}
write.csv(fao_salmon_lobster, file = "./Data/fao_salmon_lobster.csv", row.names = F)
```

Model 1:

$$
log(Q_{t,s}) = \alpha + \beta_1log(A_{t, s}) +\epsilon_{t,s}
$$
Model 2:

$$
log(Q_{t,s}) = \alpha + \beta_1log(A_{t, s}) + \sum_{t = 1}^T\gamma_tYear_t +\epsilon_{t,s}
$$

Model 3:

$$
log(Q_{t,s}) = \alpha + \beta_1log(A_{t, s}) + \sum_{t = 1}^T\gamma_tYear_t \sum_{s = 1}^S{\sigma_sSpp_s} +\epsilon_{t,s}
$$

Model 4:

$$
log(Q_{t,s,c}) = \alpha + \beta_1log(A_{t, s}) + \sum_{t = 1}^T\gamma_tYear_t \sum_{s = 1}^S{\sigma_sSpp_s} + \sum_{c = 1}^C \Omega_cCountry +\epsilon_{t,s,c}
$$

```{r}

fao_salmon_lobster_aqua <- filter(fao_salmon_lobster, source == "Aquaculture") %>% 
  group_by(year) %>% 
  summarize(Salmon = log10(sum(quantity, na.rm = T))) %>% 
  mutate(Lobster = 0) %>% 
  gather(general_name, aquaculture, -year)

fao_salmon_lobster_model <- filter(fao_salmon_lobster, source == "Catches") %>% 
  left_join(fao_salmon_lobster_aqua, by = c("year", "general_name"))

model1 <- lm(log10(quantity) ~ aquaculture, fao_salmon_lobster_model)

model2 <- lm(log10(quantity) ~ factor(year) + aquaculture, fao_salmon_lobster_model)

model3 <- lm(log10(quantity) ~ factor(year) + aquaculture + species, fao_salmon_lobster_model)

model4 <- lm(log10(quantity) ~ factor(year) + aquaculture + species + iso, fao_salmon_lobster_model)

```

```{r, results = "asis"}
stargazer::stargazer(model1, model2, model3, model4,
                     single.row = T,
                     type = "html",
                     omit = c("iso", "year", "species"),
                     intercept.bottom = F)
```

# Filter NEI from common names

