---
title: "Exploring the data"
date: "Last updated on `r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)
```

```{r}
suppressPackageStartupMessages({
  library(countrycode)
  library(seaaroundus)
  library(tidyverse)
})
```

```{r}
load("Data/FAO_data.rds")
load("Data/sau_data.rds")
```

# Put data together

We are using FAO's data for [acuaculture production](http://www.fao.org/fishery/statistics/global-aquaculture-production/en) and [wild fisheries](http://www.fao.org/fishery/statistics/global-capture-production/en).

```{r, eval = F}
# Load FAO species codes lookup table
FAO_sp_codes <- read.csv(file = "Data/FAO_sp_codes.csv", stringsAsFactors = F) %>% 
  select(species = X3Alpha_Code, common_name = Name_en, sci_name = Scientific_Name)

# Load FAO country codes lookup table
FAO_cty_codes <- read.csv(file = "Data/FAO_cty_codes.csv", stringsAsFactors = F) %>% 
  select(country = UN_CODE, iso = Name_en)

# Load FAO acuaculture timeseries
FAO_ac_ts <- read.csv(file = "Data/FAO_ac_ts.csv", stringsAsFactors = F) %>% 
  left_join(FAO_sp_codes, by = c("Species" = "species")) %>% 
  left_join(FAO_cty_codes, by = c("Country" = "country")) %>% 
  mutate(source = "Acuaculture") %>% 
  select(Year, Country, iso, source, Species, common_name, sci_name, Quantity, Value)

# Load FAO fisheries production timeseries
FAO_fi_ts <- read.csv(file = "Data/FAO_fi_ts.csv", stringsAsFactors = F) %>% 
  left_join(FAO_sp_codes, by = c("Species" = "species")) %>% 
  left_join(FAO_cty_codes, by = c("Country" = "country")) %>% 
  mutate(source = "Catches",
         Value = NA) %>% 
  select(Year, Country, iso, source, Species, common_name, sci_name, Quantity, Value)

# Join them together
FAO_ts <- rbind(FAO_ac_ts, FAO_fi_ts) %>% 
  select(year = Year,
          country = iso,
          source = source,
          species = Species,
          common_name,
          sci_name,
          quantity = Quantity,
          value =  Value) %>% 
  arrange(year, country, source, species, common_name, sci_name, quantity, value)
```

## Some data diagnostics

### Structure of the data

This listviewer widget lets us look at the "unique" values per column (each column in our dataset is a variable). For example, clicking on year will show all the years for which we have data. Note that this does not imply we have data for all countries on every year, but that there is at least one observation for any given year. The same is true for other variables.

```{r}
lapply(FAO_ts, FUN = function(x){sort(unique(x))}) %>% 
  listviewer::jsonedit()
```

### Total aquaculture and fisheries production

```{r, eval = F}
FAO_ts %>% 
  group_by(source, year, sci_name) %>% 
  summarize(Quantity = sum(quantity, na.rm = T) / 1000000) %>% 
  mutate(Unit = paste(source, sci_name)) %>% 
  ggplot(aes(x = year, y = Quantity, fill = Unit, group = Unit)) +
  geom_area(color = "black", size = 0.5) +
  cowplot::theme_cowplot() +
  theme(legend.position = c(0.1,0.7)) +
  scale_fill_brewer(palette = "green3") +
  labs(x = "Year", y = "Million tones", caption = "(Data from FAO: www.fao.org/fishery/statistics/)") +
  scale_x_continuous(labels = seq(1955, 2015, by = 10), breaks = seq(1955, 2015, by = 10))
```


### Acuaculture and wildcaught fisheries by country

You can explore landings and acuaculture production by country by playing with this widget. Click on the expand button in the bottom-left corner to view it in full.

```{r}
FAO_ts %>% 
  group_by(source, year) %>% 
  summarize(Quantity = sum(quantity, na.rm = T) / 1000000) %>% 
  ggplot(aes(x = year, y = Quantity, fill = source)) +
  geom_area(color = "black", size = 0.5) +
  cowplot::theme_cowplot() +
  theme(legend.position = c(0.1,0.7)) +
  scale_fill_brewer(palette = "green3") +
  labs(x = "Year", y = "Million tones", caption = "(Data from FAO: www.fao.org/fishery/statistics/)") +
  scale_x_continuous(labels = seq(1955, 2015, by = 10), breaks = seq(1955, 2015, by = 10))
```

# Plots from last week

## Plotting by salmon species

```{r}
FAO_ts %>% 
  filter(species %in% c("PIN", "CHI", "SOC", "COH", "SAL")) %>% 
  group_by(source, year, sci_name) %>% 
  summarize(Quantity = sum(quantity, na.rm = T) / 1000000) %>% 
  mutate(Unit = paste(source, sci_name)) %>% 
  ggplot(aes(x = year, y = Quantity, fill = Unit, group = Unit)) +
  geom_area(color = "black", size = 0.5) +
  cowplot::theme_cowplot() +
  theme(legend.position = c(0.1,0.7)) +
  scale_fill_brewer(palette = "green3") +
  labs(x = "Year", y = "Million tones", caption = "(Data from FAO: www.fao.org/fishery/statistics/)") +
  scale_x_continuous(labels = seq(1955, 2015, by = 10), breaks = seq(1955, 2015, by = 10))
```

## Plotting all salmon species

```{r}
FAO_ts %>% 
  filter(species %in% c("PIN", "CHI", "SOC", "COH", "SAL")) %>% 
  group_by(source, year) %>% 
  summarize(Quantity = sum(quantity, na.rm = T) / 1000000) %>% 
  ggplot(aes(x = year, y = Quantity, fill = source)) +
  geom_area(color = "black", size = 0.5) +
  cowplot::theme_cowplot() +
  theme(legend.position = c(0.1,0.7)) +
  scale_fill_brewer(palette = "green3") +
  labs(x = "Year", y = "Million tones", caption = "(Data from FAO: www.fao.org/fishery/statistics/)") +
  scale_x_continuous(labels = seq(1955, 2015, by = 10), breaks = seq(1955, 2015, by = 10))
```

# SAU data

## Get catch data from SeaAroundUs

```{r, eval = F}
catch_country <- function(id){
  seaaroundus::catchdata(region = "eez",
                         id = id,
                         dimension = "taxon",
                         limit = 1000) %>% 
    janitor::clean_names() %>% 
    gather(species, Landings, -years)
}

sau_catches <- seaaroundus::listregions("eez") %>% 
  arrange(id) %>% 
  mutate(catches = map(id, ~catch_country(.))) %>% 
  unnest() %>% 
  select(-id)
```

## Get value data from SeaAroundUs

```{r, eval = F}
value_country <- function(id){
  seaaroundus::catchdata(region = "eez",
                         id = id,
                         dimension = "taxon",
                         limit = 1000,
                         measure = "value") %>% 
    janitor::clean_names() %>% 
    gather(species, Value, -years)
}

sau_landings <- seaaroundus::listregions("eez") %>% 
  arrange(id) %>% 
  mutate(catches = map(id, ~value_country(.))) %>% 
  unnest() %>% 
  select(-id)
```

## Join catches and values

```{r, eval = F}
sau_data <- left_join(sau_catches, sau_landings, by = c("title", "years", "species")) %>% 
  janitor::clean_names() %>% 
  filter(landings > 0) %>% 
  mutate(ppt = value / landings)
```

# Plot SAU vs FAO

```{r}
aggregate_sau <- sau_data %>% 
  rename(year = years) %>% 
  group_by(year) %>% 
  summarize(quantity = sum(landings)) %>% 
  mutate(source = "SAU")

FAO_ts %>% 
  filter(source == "Catches") %>% 
  group_by(year) %>% 
  summarize(quantity = sum(quantity)) %>% 
  mutate(source = "FAO") %>% 
  rbind(aggregate_sau) %>% 
  ggplot(aes(x = year, y = quantity/1e6, color = source)) + 
  geom_line(size = 1) +
  scale_color_brewer(palette = "Set1") +
  labs(x = "Year", y = "Quantities (million MT)") +
  theme_minimal()
```

# Get salmon and lobster data

## from FAO

```{r}
fao_salmon_lobster <- FAO_ts %>% 
  mutate(lobster = grepl(pattern = "lobster", x = common_name),
         salmon = grepl(pattern = "salmon", x = common_name)) %>% 
  filter(lobster | salmon) %>% 
  arrange(country, year, source, species, common_name, sci_name) %>% 
  select(country, year, type = source, species, common_name, sci_name, quantity) %>% 
  mutate(source = "FAO") %>% 
  filter(!country == "", quantity > 0) %>% 
  mutate(value = NA,
         ppt = NA,
         country = countrycode(sourcevar = country, origin = "iso3c", destination = "country.name")) %>% 
  select(country, year, type, source, common_name, quantity, value, ppt)
```

## From SAU

```{r}
sau_salmon_lobster <- sau_data %>% 
  mutate(lobster = grepl(pattern = "lobster", x = species),
         salmon = grepl(pattern = "salmon", x = species)) %>% 
  filter(lobster | salmon) %>% 
  mutate(type = "Catches",
         source = "SAU") %>% 
  select(country = title, year = years, type, source, common_name = species, quantity = landings, value, ppt)

```

# Merge them together

```{r}
all_salmon_lobster <- rbind(fao_salmon_lobster, sau_salmon_lobster) %>% 
  mutate(lobster = grepl(pattern = "lobster", x = common_name),
         general_name = case_when(lobster ~ "Lobster",
                                  TRUE ~ "Salmon")) %>% 
  select(country, year, type, source, general_name, common_name, quantity, value, ppt)
```

```{r}
fao_salmon_lobster  %>%
  mutate(lobster = grepl(pattern = "lobster", x = common_name),
         general_name = case_when(lobster ~ "Lobster",
                                  TRUE ~ "Salmon")) %>%
  select(country, year, type, source, general_name, common_name, quantity, value, ppt) %>%
  group_by(year, source, type, general_name) %>% 
  summarize(quantity = sum(quantity)) %>% 
  filter(!(general_name == "Lobster" & type == "Acuaculture")) %>% 
  rename(Species = general_name,
         Type = type) %>% 
  ggplot(aes(x = year, y = quantity/1000000, color = Type, linetype = Species, group = paste(Type, source, Species))) +
  geom_line(size = 1) +
  scale_color_brewer(palette = "Set1") +
  geom_vline(xintercept = 1962, linetype = "dashed") +
  geom_text(aes(x = 1975, y = 2.5, label = "Salmon acuaculture begins"), color = "black", size = 4) +
  labs(x = "Year", y = "Quantities (million MT)", caption = "(Data from FAO: www.fao.org/fishery/statistics/)") +
  theme_minimal()
```

```{r}
write.csv(all_salmon_lobster, file = "./Data/all_salmon_lobster.csv", row.names = F)
```








